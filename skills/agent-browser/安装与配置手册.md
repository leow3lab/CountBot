# agent-browser 安装与配置手册

> 浏览器自动化 CLI 工具，专为 AI Agent 设计。支持 macOS、Windows、Linux。

## 目录

- [系统要求](#系统要求)
- [安装](#安装)
  - [macOS](#macos)
  - [Windows](#windows)
  - [Linux](#linux)
- [验证安装](#验证安装)
- [平台差异速查](#平台差异速查)
- [基本使用](#基本使用)
- [命令速查表](#命令速查表)
- [常用场景](#常用场景)
- [会话与状态管理](#会话与状态管理)
- [高级功能](#高级功能)
- [在 CountBot 中使用](#在-CountBot-中使用)
- [平台特定注意事项](#平台特定注意事项)
- [故障排查](#故障排查)
- [卸载](#卸载)
- [参考资料](#参考资料)

---

## 系统要求

| 项目 | 要求 |
|------|------|
| Node.js | 16+（推荐 18+） |
| 操作系统 | macOS 10.15+、Windows 10/11、Ubuntu 20.04+ / Debian 11+ |
| 架构 | x64 或 ARM64 |
| 磁盘空间 | 约 500MB（含 Chromium） |

---

## 安装

### macOS

#### 方式一：npm 全局安装（推荐）

```bash
npm install -g agent-browser
agent-browser install   # 下载 Chromium
```

#### 方式二：Homebrew

```bash
brew install agent-browser
agent-browser install
```

#### 方式三：npx 免安装试用

```bash
npx agent-browser install   # 首次下载 Chromium
npx agent-browser open https://example.com
```

> npx 方式每次经过 Node.js 中转，速度比全局安装慢。日常使用建议全局安装。

#### Node.js 未安装？

推荐使用 nvm 管理：

```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
source ~/.zshrc
nvm install --lts
```

---

### Windows

#### 方式一：npm 全局安装（推荐）

打开 PowerShell（建议以管理员身份运行）：

```powershell
npm install -g agent-browser
agent-browser install   # 下载 Chromium
```

#### 方式二：npx 免安装试用

```powershell
npx agent-browser install
npx agent-browser open https://example.com
```

#### Node.js 未安装？

从官网下载安装包：https://nodejs.org/

安装完成后重新打开终端，验证：

```powershell
node --version
npm --version
```

#### PowerShell 执行策略

如果遇到"禁止运行脚本"错误：

```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

---

### Linux

#### 方式一：npm 全局安装

```bash
npm install -g agent-browser
agent-browser install --with-deps   # 下载 Chromium 并安装系统依赖
```

#### 方式二：手动安装系统依赖

```bash
npm install -g agent-browser
agent-browser install
npx playwright install-deps chromium   # 安装系统库
```

#### Node.js 未安装？

```bash
# Ubuntu / Debian
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs

# 或使用 nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
source ~/.bashrc
nvm install --lts
```

---

## 验证安装

所有平台通用：

```bash
agent-browser --version
```

快速功能测试：

```bash
agent-browser open https://example.com
agent-browser snapshot -i
agent-browser screenshot /tmp/test.png   # Windows: $env:TEMP\test.png
agent-browser close
```

---

## 平台差异速查

| 操作 | macOS / Linux | Windows (PowerShell) |
|------|---------------|----------------------|
| 用户主目录 | `~` 或 `$HOME` | `$env:USERPROFILE` 或 `$HOME` |
| 临时目录 | `/tmp` | `$env:TEMP` |
| 桌面路径 | `~/Desktop` | `$env:USERPROFILE\Desktop` |
| 路径分隔符 | `/` | `\` 或 `/`（均可） |
| Shell 配置文件 | `~/.zshrc` 或 `~/.bashrc` | PowerShell Profile |
| 环境变量（临时） | `export KEY=value` | `$env:KEY = "value"` |
| 环境变量（永久） | 写入 shell 配置文件 | `[Environment]::SetEnvironmentVariable("KEY","value","User")` |
| 查找命令路径 | `which agent-browser` | `Get-Command agent-browser` |
| 进程查看 | `ps aux \| grep chromium` | `Get-Process *chromium*` |

---

## 基本使用

每个浏览器自动化任务遵循这个流程：

```
打开网页 → 快照获取元素引用 → 交互操作 → 重新快照 → 关闭
```

```bash
# 1. 打开网页
agent-browser open https://example.com

# 2. 获取可交互元素（返回 @e1, @e2 等引用）
agent-browser snapshot -i

# 3. 用引用操作元素
agent-browser click @e1
agent-browser fill @e2 "hello"

# 4. 页面变化后必须重新快照
agent-browser snapshot -i

# 5. 完成后关闭
agent-browser close
```

> **重要**：引用（`@e1`, `@e2`）在页面变化后失效，必须重新 `snapshot -i` 获取新引用。

---

## 命令速查表

### 导航

| 命令 | 说明 |
|------|------|
| `agent-browser open <url>` | 打开网页 |
| `agent-browser back` | 后退 |
| `agent-browser forward` | 前进 |
| `agent-browser reload` | 刷新 |
| `agent-browser close` | 关闭浏览器 |

### 快照与交互

| 命令 | 说明 |
|------|------|
| `agent-browser snapshot -i` | 获取可交互元素及引用 |
| `agent-browser click @e1` | 点击 |
| `agent-browser fill @e2 "text"` | 清空并输入 |
| `agent-browser type @e2 "text"` | 追加输入（不清空） |
| `agent-browser select @e1 "value"` | 下拉选择 |
| `agent-browser check @e1` | 勾选复选框 |
| `agent-browser press Enter` | 按键 |
| `agent-browser scroll down 500` | 滚动 |
| `agent-browser hover @e1` | 悬停 |

### 获取信息

| 命令 | 说明 |
|------|------|
| `agent-browser get text @e1` | 获取元素文本 |
| `agent-browser get url` | 获取当前 URL |
| `agent-browser get title` | 获取页面标题 |
| `agent-browser get value @e1` | 获取输入框值 |

### 等待

| 命令 | 说明 |
|------|------|
| `agent-browser wait @e1` | 等待元素出现 |
| `agent-browser wait --load networkidle` | 等待网络空闲 |
| `agent-browser wait --url "**/page"` | 等待 URL 匹配 |
| `agent-browser wait --text "成功"` | 等待文本出现 |
| `agent-browser wait 3000` | 等待 3 秒 |

### 截图与导出

| 命令 | 说明 |
|------|------|
| `agent-browser screenshot file.png` | 截图 |
| `agent-browser screenshot --full file.png` | 全页截图 |
| `agent-browser pdf file.pdf` | 导出 PDF |

### 语义定位器（无需引用）

```bash
agent-browser find text "登录" click
agent-browser find label "邮箱" fill "user@test.com"
agent-browser find role button click --name "提交"
agent-browser find placeholder "搜索" type "关键词"
```

---

## 常用场景

### 表单填写

```bash
agent-browser open https://example.com/form
agent-browser snapshot -i
# 输出: @e1 [input "姓名"], @e2 [input "邮箱"], @e3 [button "提交"]
agent-browser fill @e1 "张三"
agent-browser fill @e2 "zhangsan@example.com"
agent-browser click @e3
agent-browser wait --load networkidle
agent-browser snapshot -i   # 查看结果
agent-browser close
```

### 登录并保存会话

```bash
agent-browser open https://app.example.com/login
agent-browser snapshot -i
agent-browser fill @e1 "$USERNAME"       # macOS/Linux
agent-browser fill @e2 "$PASSWORD"
# Windows PowerShell: agent-browser fill @e1 $env:USERNAME
agent-browser click @e3
agent-browser wait --url "**/dashboard"
agent-browser state save auth-state.json
agent-browser close

# 下次直接加载
agent-browser state load auth-state.json
agent-browser open https://app.example.com/dashboard
```

### 数据提取

```bash
agent-browser open https://example.com/products
agent-browser snapshot -i
agent-browser get text @e5                    # 单个元素
agent-browser get text body > content.txt     # 整页文本
agent-browser get text @e1 --json             # JSON 格式
agent-browser close
```

### JavaScript 执行

```bash
# 简单表达式
agent-browser eval 'document.title'

# 复杂脚本用 heredoc（macOS/Linux）
agent-browser eval --stdin <<'EOF'
Array.from(document.querySelectorAll('a'))
  .map(a => ({ text: a.textContent, href: a.href }))
EOF

# Windows PowerShell 用管道
'document.querySelectorAll("img").length' | agent-browser eval --stdin
```

---

## 会话与状态管理

### 命名会话（隔离 cookies 和存储）

```bash
agent-browser --session site1 open https://site-a.com
agent-browser --session site2 open https://site-b.com
agent-browser session list
agent-browser --session site1 close
```

### 自动持久化会话

```bash
agent-browser --session-name myapp open https://app.example.com
# ... 登录操作 ...
agent-browser close   # 状态自动保存到 ~/.agent-browser/sessions/

# 下次自动恢复
agent-browser --session-name myapp open https://app.example.com
```

### 手动保存/加载状态

```bash
agent-browser state save auth.json
agent-browser state load auth.json
agent-browser state list
agent-browser state clear myapp
agent-browser state clean --older-than 7   # 清理 7 天前的状态
```

### 加密会话

```bash
# macOS/Linux
export AGENT_BROWSER_ENCRYPTION_KEY=$(openssl rand -hex 32)

# Windows PowerShell
$env:AGENT_BROWSER_ENCRYPTION_KEY = -join ((1..32) | ForEach-Object { '{0:x2}' -f (Get-Random -Max 256) })

agent-browser --session-name secure open https://app.example.com
```

---

## 高级功能

### 可视化调试

```bash
agent-browser --headed open https://example.com   # 显示浏览器窗口
agent-browser highlight @e1                        # 高亮元素
```

### 视频录制

```bash
agent-browser record start demo.webm
# ... 执行操作 ...
agent-browser record stop
```

### 设备模拟

```bash
agent-browser set viewport 1920 1080
agent-browser set device "iPhone 14"
agent-browser set media dark                # 深色模式
```

### 网络控制

```bash
agent-browser --proxy http://proxy:8080 open https://example.com
agent-browser network route "*/ads/*" --abort       # 拦截广告
agent-browser network route "*/api/data" --body '{"mock": true}'   # 模拟响应
```

### iOS Simulator（仅 macOS）

需要 Xcode 和 Appium：

```bash
npm install -g appium && appium driver install xcuitest

agent-browser device list
agent-browser -p ios --device "iPhone 16 Pro" open https://example.com
agent-browser -p ios snapshot -i
agent-browser -p ios tap @e1
agent-browser -p ios swipe up
agent-browser -p ios screenshot mobile.png
agent-browser -p ios close
```

### 连接已有 Chrome

```bash
agent-browser --auto-connect open https://example.com
# 或指定 CDP 端口
agent-browser --cdp 9222 snapshot
```

### 打开本地文件

```bash
agent-browser --allow-file-access open file:///path/to/document.pdf
agent-browser --allow-file-access open file:///path/to/page.html
```

---

## 在 CountBot 中使用

### 前置条件

确保 agent-browser 已全局安装并可用：

```bash
agent-browser --version
```

### 工作方式

CountBot 的 AI Agent 通过 Shell 工具直接调用 agent-browser 命令。`skills/agent-browser/SKILL.md` 已配置：

```yaml
allowed-tools: Bash(npx agent-browser:*), Bash(agent-browser:*)
```

### 对话示例

```
用户: 帮我打开 example.com 并截图
AI:   [调用 agent-browser open / screenshot / close]
      截图已保存。

用户: 帮我登录 GitHub，查看我的 star 列表
AI:   [调用一系列 agent-browser 命令完成登录和数据提取]
```

### 集成测试

```bash
python3 tests/test_agent_browser_integration.py
```

---

## 平台特定注意事项

### macOS

| 问题 | 解决方案 |
|------|----------|
| Gatekeeper 阻止 Chromium | `xattr -d com.apple.quarantine ~/.cache/ms-playwright/chromium-*/chrome-mac/Chromium.app` |
| 需要屏幕录制权限 | 系统设置 → 隐私与安全性 → 屏幕录制 → 添加终端 |
| Apple Silicon 架构确认 | `file $(which agent-browser)` 应显示 arm64 |
| 使用 nvm 时路径问题 | 确保 `nvm use <版本>` 后再安装 |
| 公司网络代理 | `agent-browser --proxy http://proxy:8080 open <url>` |

zsh 快捷别名（可选）：

```bash
# 添加到 ~/.zshrc
alias ab='agent-browser'
alias abo='agent-browser open'
alias abs='agent-browser snapshot -i'
alias abc='agent-browser close'
```

### Windows

| 问题 | 解决方案 |
|------|----------|
| 执行策略限制 | `Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser` |
| 防火墙弹窗 | 点击"允许访问"，或添加规则：`New-NetFirewallRule -DisplayName "agent-browser" -Direction Inbound -Program "$env:APPDATA\npm\node_modules\agent-browser\node_modules\playwright\*" -Action Allow` |
| 杀毒软件误报 | 将 `%LOCALAPPDATA%\ms-playwright` 和 `%APPDATA%\npm\node_modules\agent-browser` 加入白名单 |
| 长路径限制 | 注册表：`HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem` 设置 `LongPathsEnabled = 1` |
| 中文路径编码 | PowerShell 中执行 `[Console]::OutputEncoding = [System.Text.Encoding]::UTF8` |

性能优化（可选）：

```powershell
# 排除 Chromium 目录的实时扫描
Add-MpPreference -ExclusionPath "$env:LOCALAPPDATA\ms-playwright"
```

### Linux

| 问题 | 解决方案 |
|------|----------|
| 缺少系统依赖 | `agent-browser install --with-deps` 或 `npx playwright install-deps chromium` |
| 无头服务器无显示 | agent-browser 默认 headless 模式，无需 X11 |
| Docker 中运行 | 需要 `--no-sandbox` 或以非 root 用户运行 |

---

## 故障排查

### 通用问题

| 症状 | 原因 | 解决 |
|------|------|------|
| `Daemon not found` | npm 包未正确安装 | `npm install -g agent-browser` |
| 页面加载超时 | 网络慢或页面复杂 | 在 `open` 后加 `wait --load networkidle` |
| 引用 `@e1` 无效 | 页面变化后引用失效 | 重新执行 `snapshot -i` |
| `command not found` | 未安装或不在 PATH 中 | 检查 `which agent-browser`（macOS/Linux）或 `Get-Command agent-browser`（Windows） |
| Chromium 启动失败 | 浏览器未下载 | `agent-browser install` |

### 查看详细日志

```bash
# macOS / Linux
DEBUG=pw:* agent-browser open https://example.com

# Windows PowerShell
$env:DEBUG = "pw:*"
agent-browser open https://example.com
```

### 重新安装

```bash
npm uninstall -g agent-browser
npm install -g agent-browser
agent-browser install
```

### 验证脚本

#### Bash（macOS / Linux）

```bash
#!/bin/bash
set -e
echo "检查安装..."
agent-browser --version || { echo "❌ 未安装"; exit 1; }
echo "打开网页..."
agent-browser open https://example.com
echo "快照..."
agent-browser snapshot -i
echo "关闭..."
agent-browser close
echo "✅ 所有测试通过"
```

#### PowerShell（Windows）

```powershell
Write-Host "检查安装..."
agent-browser --version
if ($LASTEXITCODE -ne 0) { Write-Host "❌ 未安装"; exit 1 }
Write-Host "打开网页..."
agent-browser open https://example.com
Write-Host "快照..."
agent-browser snapshot -i
Write-Host "关闭..."
agent-browser close
Write-Host "✅ 所有测试通过"
```

#### Python（跨平台）

```bash
python3 tests/test_agent_browser_integration.py
```

---

## 卸载

### macOS / Linux

```bash
npm uninstall -g agent-browser
rm -rf ~/.cache/ms-playwright
rm -rf ~/.agent-browser

# Homebrew 安装的
brew uninstall agent-browser
```

### Windows

```powershell
npm uninstall -g agent-browser
Remove-Item -Recurse -Force "$env:LOCALAPPDATA\ms-playwright"
Remove-Item -Recurse -Force "$env:USERPROFILE\.agent-browser"
```

---

## 环境变量（可选）

| 变量 | 说明 | 示例 |
|------|------|------|
| `AGENT_BROWSER_SESSION` | 默认会话名 | `mysession` |
| `AGENT_BROWSER_EXECUTABLE_PATH` | 自定义浏览器路径 | `/usr/bin/google-chrome` |
| `AGENT_BROWSER_EXTENSIONS` | 加载浏览器扩展 | `/path/ext1,/path/ext2` |
| `AGENT_BROWSER_HOME` | 自定义安装位置 | 通常不需要设置 |
| `AGENT_BROWSER_ENCRYPTION_KEY` | 会话加密密钥 | 64 位十六进制字符串 |

---

## 参考资料

| 资源 | 链接 |
|------|------|
| 官方网站 | https://agent-browser.dev/ |
| GitHub 仓库 | https://github.com/vercel-labs/agent-browser |
| npm 包 | https://www.npmjs.com/package/agent-browser |
| 完整命令参考 | [references/commands.md](./references/commands.md) |
| 会话管理 | [references/session-management.md](./references/session-management.md) |
| 认证处理 | [references/authentication.md](./references/authentication.md) |
| 引用生命周期 | [references/snapshot-refs.md](./references/snapshot-refs.md) |
| 视频录制 | [references/video-recording.md](./references/video-recording.md) |
| 代理配置 | [references/proxy-support.md](./references/proxy-support.md) |
| AI 技能定义 | [SKILL.md](./SKILL.md) |
| 模板脚本 | [templates/](./templates/) |
